<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<style>
    body {
        padding-top: 50px;
    }
    .tv-lightweight-charts {
        margin: auto;
    }
</style>

<body>
</body>

<script>
    const chart = LightweightCharts.createChart(document.body, { width: 1800, height: 600 });

    $.ajax({
        type: 'GET',
        url: '/Test',
        success: function (data, status, xhr) {

            const obj = JSON.parse(data);
            const charts = new Map();

            charts.set("Main", { chart: chart, series: new Map() });
            for (var i = 0; i < obj.length; i++) {
                var dataSet = [];

                for (var j = 0; j < obj[i].plots.length; j++) {
                    dataSet.push(obj[i].plots[j]);
                }

                var config = obj[i].config ?? undefined;
                var type = obj[i].type;
                var markers = obj[i].markers;
                var chartName = obj[i].chartName;
                var name = obj[i].name;

                switch (obj[i].postion)
                {
                    case 0:
                        let serieMain = setSerie(type, chart, config, markers);
                        charts.get("Main").series.set(serieMain, name);
                        serieMain.setData(dataSet);
                        break;
                    case 1:
                        var otherChart = undefined;
                        if (charts.has(chartName))
                        {
                            otherChart = charts.get(chartName).chart;
                        }
                        else
                        {
                            otherChart = LightweightCharts.createChart(document.body, { width: 1800, height: 200 });
                            charts.set(chartName, { chart: otherChart, series: new Map() });
                        }

                        chart.timeScale().subscribeVisibleLogicalRangeChange(timeRange => otherChart.timeScale().setVisibleLogicalRange(timeRange));
                        otherChart.timeScale().subscribeVisibleLogicalRangeChange(timeRange => chart.timeScale().setVisibleLogicalRange(timeRange));
                        let serieOther = setSerie(type, otherChart, config, markers)
                        serieOther.setData(dataSet);
                        charts.get(chartName).series.set(serieOther, name);

                        break;
                }
            }

            var chartId = 0;
            
            charts.forEach((value, key, _) => {

                var chartHtml = document.getElementsByClassName("tv-lightweight-charts")[chartId];
                var list = document.createElement("p");
                var title = document.createElement("h2");
                title.innerHTML = key;
                
                var index = 0;
                value.series.forEach((name, _, __) => {
                    var node = document.createElement("span");
                    node.setAttribute("class", key + "_" + name + "_" + index);
                    node.innerHTML = `${name} : null | `;
                    list.appendChild(node)
                    index++;
                });    
                
                document.body.insertBefore(title, chartHtml);
                document.body.insertBefore(list, chartHtml);

                value.chart.subscribeCrosshairMove(param => {
                    if (param.time) {
                        var index = 0;
                        param.seriesData.forEach((serie, k, a) => {

                            let name = value.series.get(k);
                            var v = serie.value;
                            if (v == undefined) {
                                v = serie.close;
                            }

                            var data = document.getElementsByClassName(key + "_" + name + "_" + index)[0];
                            data.innerHTML = `${name} : ${v.toFixed(2)} | `;
                            index++;

                        })
                    }
                });

                chartId++;

            });
        }
    });

    function setSerie(type, target, config, markers) {

        var series = null;
        switch (type)
        {
            case 0:
                series = target.addSeries(LightweightCharts.CandlestickSeries, config);
                break;
            case 1:
                series = target.addSeries(LightweightCharts.LineSeries, config);
                break;
            case 3:
                series = target.addSeries(LightweightCharts.AreaSeries, config);
                break;
        }

        LightweightCharts.createSeriesMarkers(series, markers);

        return series;
    }

    function getCrosshairDataPoint(series, param) {
        if (!param.time) {
            return null;
        }
        const dataPoint = param.seriesData.get(series);
        return dataPoint || null;
    }

    function syncCrosshair(chart, series, dataPoint) {
        if (dataPoint) {
            chart.setCrosshairPosition(dataPoint.value, dataPoint.time, series);
            return;
        }
        chart.clearCrosshairPosition();
    }
</script>